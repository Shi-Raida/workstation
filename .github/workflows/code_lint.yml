name: Code Lint

on:
  workflow_call:
    outputs:
      yaml-lint-result:
        description: "Result of YAML linting"
        value: ${{ jobs.lint-summary.outputs.yaml-lint-result }}
      shell-lint-result:
        description: "Result of shell script linting"
        value: ${{ jobs.lint-summary.outputs.shell-lint-result }}
      ansible-lint-result:
        description: "Result of Ansible linting"
        value: ${{ jobs.lint-summary.outputs.ansible-lint-result }}
      overall-result:
        description: "Overall linting result"
        value: ${{ jobs.lint-summary.outputs.overall-result }}

permissions:
  actions: read
  contents: read
  checks: write

jobs:
  yaml-lint:
    name: YAML Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.lint.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Run yamllint
        id: lint
        run: |
          echo "📝 Linting YAML files with yamllint..."
          yamllint -c .yamllint.yml -f parsable . > yamllint-report.txt 2>&1 || true

          if [ -f yamllint-report.txt ] && [ -s yamllint-report.txt ]; then
            ISSUE_COUNT=$(wc -l < yamllint-report.txt)
            echo "YAML lint found $ISSUE_COUNT issues"
            echo "First 20 issues:"
            head -20 yamllint-report.txt
          else
            echo "No YAML lint issues found"
            touch yamllint-report.txt  # Create empty file
          fi
        continue-on-error: true

      - name: Upload yamllint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: yamllint-report
          path: yamllint-report.txt
          retention-days: 7

  shell-lint:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.lint.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run shellcheck
        id: lint
        uses: ludeeus/action-shellcheck@master
        with:
          ignore_paths: .venv .git
          ignore_names: node_modules
          additional_files: 'scripts'
        continue-on-error: true

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
      fail-fast: false
    outputs:
      result: ${{ steps.lint.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .cache/pip
            .venv
          key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ matrix.python-version }}-
            pip-${{ runner.os }}-

      - name: Install Python dependencies
        run: |
          python --version
          pip --version
          pip install virtualenv
          virtualenv .venv
          source .venv/bin/activate
          pip install ansible ansible-lint

      - name: Run ansible-lint
        id: lint
        run: |
          source .venv/bin/activate
          echo "🔧 Linting Ansible playbooks with ansible-lint..."
          ansible-lint --exclude .venv -f parsable > ansible-lint-report-${{ matrix.python-version }}.txt 2>&1 || true

          if [ -f ansible-lint-report-${{ matrix.python-version }}.txt ] && [ -s ansible-lint-report-${{ matrix.python-version }}.txt ]; then
            ISSUE_COUNT=$(wc -l < ansible-lint-report-${{ matrix.python-version }}.txt)
            echo "Ansible lint (Python ${{ matrix.python-version }}) found $ISSUE_COUNT issues"
          else
            echo "No Ansible lint issues found (Python ${{ matrix.python-version }})"
          fi
        continue-on-error: true

      - name: Upload ansible-lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-lint-report-${{ matrix.python-version }}
          path: ansible-lint-report-${{ matrix.python-version }}.txt
          retention-days: 7

  lint-summary:
    name: Linting Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, shell-lint, ansible-lint]
    if: always()
    outputs:
      yaml-lint-result: ${{ needs.yaml-lint.outputs.result }}
      shell-lint-result: ${{ needs.shell-lint.outputs.result }}
      ansible-lint-result: ${{ needs.ansible-lint.result }}
      overall-result: ${{ steps.determine-result.outputs.result }}

    steps:
      - name: Download all linting reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*lint-report*"
          merge-multiple: true

      - name: Generate linting summary
        run: |
          echo "# 📝 Code Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # YAML Lint Summary
          if [ -f yamllint-report.txt ]; then
            if [ -s yamllint-report.txt ]; then
              YAML_ISSUES=$(wc -l < yamllint-report.txt)
              echo "## ⚠️ YAML Validation (yamllint)" >> $GITHUB_STEP_SUMMARY
              echo "Found $YAML_ISSUES formatting/style issues" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>View issues</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -10 yamllint-report.txt >> $GITHUB_STEP_SUMMARY
              if [ $YAML_ISSUES -gt 10 ]; then
                echo "... and $(($YAML_ISSUES - 10)) more issues" >> $GITHUB_STEP_SUMMARY
              fi
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ✅ YAML Validation (yamllint)" >> $GITHUB_STEP_SUMMARY
              echo "No YAML formatting issues found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ⚠️ YAML Validation (yamllint)" >> $GITHUB_STEP_SUMMARY
            echo "No report generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Shell Lint Summary
          echo "## 🐚 Shell Script Validation (shellcheck)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.shell-lint.result }}" == "success" ]; then
            echo "No shell script issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Shell script issues detected - check job logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ansible Lint Summary
          echo "## 🔧 Ansible Validation (ansible-lint)" >> $GITHUB_STEP_SUMMARY
          ANSIBLE_TOTAL_ISSUES=0
          ANSIBLE_FILES_WITH_ISSUES=0

          for report in ansible-lint-report-*.txt; do
            if [ -f "$report" ] && [ -s "$report" ]; then
              ISSUES=$(wc -l < "$report")
              ANSIBLE_TOTAL_ISSUES=$((ANSIBLE_TOTAL_ISSUES + ISSUES))
              ANSIBLE_FILES_WITH_ISSUES=$((ANSIBLE_FILES_WITH_ISSUES + 1))
            fi
          done

          if [ $ANSIBLE_TOTAL_ISSUES -gt 0 ]; then
            echo "Found $ANSIBLE_TOTAL_ISSUES Ansible issues across $ANSIBLE_FILES_WITH_ISSUES Python versions" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Ansible validation issues found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary Table
          echo "## 📊 Linting Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Check | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Individual job status
          if [ "${{ needs.yaml-lint.result }}" == "success" ]; then
            echo "| YAML Validation | ✅ | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| YAML Validation | ⚠️ | Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.shell-lint.result }}" == "success" ]; then
            echo "| Shell Script Validation | ✅ | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Shell Script Validation | ⚠️ | Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.ansible-lint.result }}" == "success" ]; then
            echo "| Ansible Validation | ✅ | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ansible Validation | ⚠️ | Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Determine overall result
        id: determine-result
        run: |
          # Linting issues are generally warnings, not failures
          # Only fail if there are severe issues that prevent proper functioning
          if [ "${{ needs.ansible-lint.result }}" == "failure" ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "❌ Critical Ansible linting issues found"
            exit 1
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "✅ Linting completed - issues are warnings only"
          fi
